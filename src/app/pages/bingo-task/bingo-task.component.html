<div class="dashboard-layout">
  <!-- SIDEBAR -->
  <app-sidebar></app-sidebar>

  <!-- MAIN CONTENT -->
  <div class="dashboard-content game-bg">
    <div class="bingo-container">

      <!-- GAME TOP BAR -->
      <div class="game-topbar">
        <div class="game-title">
          <div class="title-main">TASK BINGO</div>
          <div class="title-sub">Complete tasks • Earn points • Get BINGO!</div>
        </div>

        <div class="hud">
          <!-- Card size chooser -->
          <div class="hud-chip" *ngIf="hasChosenSize">
            <span class="hud-label">Card</span>
            <div class="hud-actions">
              <!-- ✅ Employee: 3×3 opens picker (TS handles this inside setBoardSize) -->
              <button class="hud-btn" [class.active]="gridSize === 3" (click)="setBoardSize(3)">3×3</button>
              <button class="hud-btn" [class.active]="gridSize === 5" (click)="setBoardSize(5)">5×5</button>
            </div>
          </div>

          <!-- Completed counter -->
          <div class="hud-chip">
            <span class="hud-label">Completed</span>
            <span class="hud-value">{{ completedCount }} / {{ totalTasks }}</span>
          </div>

          <!-- Change card button -->
          <div class="hud-chip" *ngIf="hasChosenSize">
            <button class="hud-btn" (click)="backToChoice()">Change Card</button>
          </div>
        </div>
      </div>

      <!-- ✅ 3×3 CARD PICKER OVERLAY -->
      <div class="card-picker-overlay" *ngIf="showCardPicker && isEmployee">
        <div class="card-picker">
          <div class="picker-head">
            <div>
              <h2>Select a 3×3 Daily Fun Card</h2>
              <p>Pick one to play. You can switch anytime.</p>
            </div>
            <button class="picker-close" (click)="showCardPicker=false">✕</button>
          </div>

          <div class="picker-grid">
            <button class="picker-card" *ngFor="let card of dailyCards3x3" (click)="choose3x3Card(card.id)">

              <div class="picker-title">{{ card.title }}</div>
              <div class="picker-sub" *ngIf="card.subtitle">{{ card.subtitle }}</div>

              <!-- mini preview 3×3 -->
              <div class="mini-grid">
                <div class="mini-cell" *ngFor="let t of card.tasks">
                  {{ t.name }}
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- CHOOSE CARD -->
      <div class="choose-screen" *ngIf="!hasChosenSize">
        <div class="choose-card">
          <h1 class="choose-title">Choose your Bingo Card</h1>
          <p class="choose-sub">Pick a card size to start playing.</p>

          <div class="choose-actions">
            <!-- ✅ Employee selects 3×3 -> opens picker -->
            <button class="choose-btn" (click)="start3x3()">
              3×3 Daily Fun Card
              <span class="hint">Pick from multiple 3×3 sets • Win: row/col/diagonal</span>
            </button>

            <button class="choose-btn gold" (click)="setBoardSize(5)">
              5×5 Task Card
              <span class="hint">Has FREE center • Win: row/col/diagonal</span>
            </button>
          </div>
        </div>
      </div>


      <!-- BINGO CARD -->

      <section class="bingo-card arcade-panel" #bingoCard *ngIf="hasChosenSize">
        <div class="card-header">
          <h2>BINGO Challenge</h2>
          <div class="completion-badge">
            {{ completedCount }} / {{ totalTasks }} Done
          </div>
        </div>


        <div class="card-bingo-balls" *ngIf="gridSize === 3">
          <div class="ball" *ngFor="let l of bingoBalls" [ngClass]="l.toLowerCase()">

            {{ l }}
          </div>
        </div>

        <div class="bingo-wrapper">
          <div class="bingo-column" *ngFor="let col of columns">
            <div class="column-letter bubble" *ngIf="gridSize === 5">
              {{ letters[col] }}
            </div>

            <div class="bingo-grid-column">
              <div
                class="bingo-cell"
                *ngFor="let task of tasks.slice(col * gridSize, col * gridSize + gridSize)"
                [class.locked]="task?.verificationStatus !== 'AVAILABLE' || task?.isFree"
                [class.free]="task?.isFree"
                (click)="onCellClick(task)"
              >
                <div
                  class="card-3d"
                  [class.is-flipped]="task?.verificationStatus !== 'AVAILABLE' || task?.isFree"
                >
                  <!-- FRONT -->
                  <div class="card-face card-front">
                    <div class="cell-gloss"></div>

                    <div class="cell-content">
                      <ng-container *ngIf="!task?.isFree; else freeFront">
                        <div class="task-name">{{ task?.name }}</div>
                        <div class="task-points">+{{ task?.points }} pts</div>
                      </ng-container>

                      <ng-template #freeFront>
                        <div class="free-text">FREE</div>
                      </ng-template>
                    </div>
                  </div>

                  <!-- BACK -->

                  <div class="card-face card-back">

                    <div class="back-letter">
                      {{ task?.isFree ? 'FREE' : task?.verificationStatus }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="legend game-legend">
          <div class="legend-item">
            <span class="legend-box completed"></span>
            <span>Verified</span>
          </div>
          <div class="legend-item">
            <span class="legend-box available"></span>
            <span>Available</span>
          </div>
        </div>
      </section>
    </div>

    <!-- CELEBRATION OVERLAY -->
    <div class="celebration-overlay" *ngIf="showOverlay">
      <canvas #confettiCanvas class="confetti"></canvas>
      <div
        class="celebration-word play"
        [style.left.px]="overlayPos.x"
        [style.top.px]="overlayPos.y"
      >
        <span class="word">{{ overlayType === 'bingo' ? 'BINGO' : 'BLACKOUT' }}</span>

      </div>
    </div>

    <div class="hand-cursor"></div>
  </div>
</div>

<!-- TASK SUBMISSION MODAL -->
<div class="modal-backdrop" *ngIf="selectedTask">
  <div class="modal">
    <div class="modal-header">
      <h3>Submit Task Proof</h3>
      <button class="icon-btn" type="button" (click)="closeTaskModal()">✕</button>
    </div>

    <div class="modal-body">
      <p><strong>Task:</strong> {{ selectedTask?.name }}</p>
      <p><strong>Points:</strong> {{ selectedTask?.points }}</p>

      <div class="proof-box">
        <label>Upload screenshot/photo (required)</label>
        <input type="file" accept="image/*" (change)="onProofFileSelected($event)" />

        <div class="proof-preview" *ngIf="selectedProofPreview">
          <img [src]="selectedProofPreview" alt="Proof preview" />
        </div>
      </div>

      <div class="proof-note">
        <label>Note (optional)</label>
        <input [(ngModel)]="selectedProofNote" type="text" placeholder="Short explanation..." />
      </div>

      <p class="muted" *ngIf="selectedTask?.verificationStatus === 'PENDING'">
        Pending admin verification.
      </p>

      <p class="muted" *ngIf="selectedTask?.verificationStatus === 'REJECTED'">
        Rejected — please resubmit with clearer proof.
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn ghost" type="button" (click)="closeTaskModal()">Cancel</button>
      <button class="btn" type="button" (click)="submitProof()" [disabled]="!selectedProofPreview">
        Submit for Verification
      </button>
    </div>
  </div>
</div>
