<div class="dashboard-layout">
  <!-- SIDEBAR -->
  <app-sidebar></app-sidebar>

  <!-- MAIN CONTENT -->
  <div class="dashboard-content game-bg">
    <div class="bingo-container">

      <!-- GAME TOP BAR -->
      <div class="game-topbar">
        <div class="game-title">
          <div class="title-main">TASK BINGO</div>
          <div class="title-sub">Complete tasks ‚Ä¢ Earn points ‚Ä¢ Get BINGO!</div>
        </div>

        <div class="hud">
          <!-- Card size chooser -->
          <div class="hud-chip" *ngIf="hasChosenSize">
            <span class="hud-label">Card</span>
            <div class="hud-actions">
              <button class="hud-btn" [class.active]="gridSize === 3" (click)="setBoardSize(3)">3√ó3</button>
              <button class="hud-btn" [class.active]="gridSize === 5" (click)="setBoardSize(5)">5√ó5</button>
            </div>
          </div>

          <!-- Completed counter (counts VERIFIED + BINGOLINE + FREE only) -->
          <div class="hud-chip">
            <span class="hud-label">Completed</span>
            <span class="hud-value">{{ completedCount }} / {{ totalTasks }}</span>
          </div>

          <!-- Change card button -->
          <div class="hud-chip" *ngIf="hasChosenSize">
            <button class="hud-btn" (click)="backToChoice()">Change Card</button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ CARD PICKER OVERLAY (PAGINATION) -->
      <div class="card-picker-overlay" *ngIf="showCardPicker && isEmployee">
        <div class="card-picker-pagination">
          <div class="picker-head">
            <div>
              <h2>Select a {{ cardPickerSize }}√ó{{ cardPickerSize }} Card</h2>
              <p>{{ currentCardIndex + 1 }} of {{ cardCount }}</p>
            </div>
            <button class="picker-close" (click)="showCardPicker=false">‚úï</button>
          </div>

          <!-- Single Card Display -->
          <div class="picker-card-container" *ngIf="currentCard">
            <div class="picker-card-single">
              <div class="picker-title">{{ currentCard.title }}</div>
              <div class="picker-sub" *ngIf="currentCard.subtitle">{{ currentCard.subtitle }}</div>

              <!-- Full preview (5√ó5 or 3√ó3) -->
              <div class="preview-grid" 
                   [class.preview-grid-3x3]="cardPickerSize === 3"
                   [class.preview-grid-5x5]="cardPickerSize === 5">
                <div class="preview-cell" *ngFor="let t of currentCard.tasks">
                  <div class="cell-label">{{ t.name === 'FREE' ? '‚òÖ' : t.name }}</div>
                  <div class="cell-points" *ngIf="t.name !== 'FREE'">+{{ t.points }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination Controls & Select Button -->
          <div class="picker-footer">
            <!-- Pagination Controls -->
            <div class="picker-pagination-controls">
              <button class="pagination-btn prev-btn" 
                      [disabled]="isFirstCard"
                      (click)="prevCard()">
                ‚Üê Previous
              </button>

              <div class="pagination-info">
                <span class="dot" *ngFor="let i of [0,1,2,3,4,5]" 
                      [class.active]="i === currentCardIndex"
                      [style.display]="i >= cardCount ? 'none' : 'inline-block'"></span>
              </div>

              <button class="pagination-btn next-btn"
                      [disabled]="isLastCard"
                      (click)="nextCard()">
                Next ‚Üí
              </button>
            </div>

            <!-- Select Button -->
            <button class="picker-select-btn" (click)="chooseCard()">
              Select This Card
            </button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ CHOICE SCREEN FIRST -->
      <div class="choose-screen" *ngIf="!hasChosenSize">
        <div class="choose-card">
          <h1 class="choose-title">Choose your Bingo Card</h1>
          <p class="choose-sub">Pick a card size to start playing.</p>

          <div class="choose-actions">
            <button class="choose-btn" (click)="start3x3()">
              3√ó3 Daily Fun Cards
              <span class="hint">Pick from multiple fun card sets</span>
            </button>

            <button class="choose-btn gold" (click)="start5x5()">
              5√ó5 Task Cards
              <span class="hint">Choose from 3 different task themes</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ GAME CARD -->
      <section class="bingo-card arcade-panel" #bingoCard *ngIf="hasChosenSize">
        <div class="card-header">
          <h2>BINGO Challenge</h2>
          <div class="completion-badge">{{ completedCount }} / {{ totalTasks }} Done</div>
        </div>

        <!-- ‚úÖ balls for 3√ó3 -->
        <div class="card-bingo-balls" *ngIf="hasChosenSize && gridSize === 3">
          <div class="ball" *ngFor="let l of ['B','I','N','G','O']" [ngClass]="l.toLowerCase()">
            {{ l }}
          </div>
        </div>

        <div class="bingo-wrapper">
          <div class="bingo-column" *ngFor="let col of columns">
            <div class="column-letter bubble" *ngIf="gridSize === 5">
              {{ letters[col] }}
            </div>

            <div class="bingo-grid-column">
              <div class="bingo-cell" *ngFor="let task of tasks.slice(col * gridSize, col * gridSize + gridSize)"
                [class.locked]="task.status !== 'available' || task.isFree" [class.free]="task.isFree"
                (click)="onCellClick(task)">
                <!-- ‚úÖ Flip: anything not available flips (pending/verified/bingoLine/free) -->
                <div class="card-3d" [class.is-flipped]="task.status !== 'available' || task.isFree">
                  <!-- FRONT -->
                  <div class="card-face card-front">
                    <div class="cell-gloss"></div>

                    <div class="cell-content">
                      <ng-container *ngIf="!task.isFree; else freeFront">
                        <div class="task-name">{{ task.name }}</div>
                        <div class="task-points">+{{ task.points }} pts</div>
                      </ng-container>

                      <ng-template #freeFront>
                        <div class="free-text">FREE</div>
                      </ng-template>
                    </div>
                  </div>

                  <!-- BACK (UPDATED: FREE / PENDING / WIN) -->
                  <div class="card-face card-back" [attr.data-letter]="
                      task.isFree ? 'FREE' :
                      task.status === 'pending' ? 'PENDING' :
                      (task.status === 'verified' || task.status === 'bingoLine') ? 'WIN' : ''
                    ">
                    <div class="back-letter">
                      {{
                      task.isFree ? 'FREE' :
                      task.status === 'pending' ? 'PENDING' :
                      (task.status === 'verified' || task.status === 'bingoLine') ? 'WIN' : ''
                      }}
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Legend (optional: you can keep your old labels) -->
        <div class="legend game-legend">
          <div class="legend-item">
            <span class="legend-box bingoLine"></span>
            <span>BINGO Line (Bonus)</span>
          </div>
          <div class="legend-item">
            <span class="legend-box completed"></span>
            <span>Verified</span>
          </div>
          <div class="legend-item">
            <span class="legend-box available"></span>
            <span>Available</span>
          </div>
        </div>
      </section>
    </div>

    <!-- ‚úÖ TASK SUBMIT DIALOG (NEW) -->
    <div class="task-dialog-overlay" *ngIf="showTaskDialog">
      <div class="task-dialog">

        <div class="task-dialog__head">
          <div>
            <h3 class="task-dialog__title">{{ activeTask?.name }}</h3>
            <p class="task-dialog__meta">
              Points: <strong>+{{ activeTask?.points }}</strong>
            </p>
          </div>
          <button class="task-dialog__close" (click)="closeTaskDialog()">‚úï</button>
        </div>

        <div class="task-dialog__body">

          <!-- Completion Date -->
          <label class="field">
            <span>Completion Date</span>
            <input type="date" [(ngModel)]="completionDateISO" />
          </label>

          <!-- File Upload -->
          <label class="field">
            <span>Submit Proof (images/files, multiple allowed)</span>
            <input type="file" multiple (change)="onProofFilesSelected($event)" />
          </label>

          <!-- Error -->
          <div class="error-text" *ngIf="filePreviews.length === 0">
            ‚ö† At least one proof file is required.
          </div>

          <!-- Preview -->
          <div class="proof-grid" *ngIf="filePreviews.length">
            <a class="proof-card" *ngFor="let p of filePreviews" [href]="p.url" target="_blank">
              <ng-container *ngIf="p.type === 'image'; else fileTpl">
                <img [src]="p.url" [alt]="p.name" />
              </ng-container>
              <ng-template #fileTpl>
                <div class="proof-file">
                  <div class="icon">üìÑ</div>
                  <div class="name">{{ p.name }}</div>
                </div>
              </ng-template>
            </a>
          </div>

        </div>

        <!-- ‚úÖ ACTIONS INSIDE DIALOG -->
        <div class="task-dialog__actions">
          <button class="btn btn--ghost" (click)="closeTaskDialog()">Cancel</button>
          <button class="btn btn--primary" [disabled]="filePreviews.length === 0" (click)="submitTaskProof()">
            Submit
          </button>
        </div>

      </div>
    </div>


    <!-- ‚úÖ WIN TOAST (NEW) -->
    <div class="win-toast" *ngIf="showWinToast">
      üéâ {{ winToastText }}
    </div>

    <!-- ‚úÖ OVERLAY (NO BACKGROUND) -->
    <div class="celebration-overlay" *ngIf="showOverlay" aria-hidden="true">
      <canvas #confettiCanvas class="confetti" *ngIf="overlayType === 'bingo'"></canvas>

      <div class="celebration-word play" [class.blackout]="overlayType === 'blackout'" [style.left.px]="overlayPos.x"
        [style.top.px]="overlayPos.y">
        <span class="word" *ngIf="overlayType === 'bingo'">BINGO</span>
        <span class="word" *ngIf="overlayType === 'blackout'">BLACKOUT</span>
      </div>
    </div>

    <div class="hand-cursor"></div>
  </div>
</div>